<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Mini Test Zdolno≈õci Muzycznych</title>
  <script>
let mediaRecorder;
let audioChunks = [];

function startRecording(question) {
    console.log("üü¢ startRecording() wywo≈Çane dla:", question);

    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        console.log("üé§ Nagrywanie rozpoczƒôte...");

        audioChunks = []; // Resetujemy nagranie

        mediaRecorder.ondataavailable = event => {
            console.log("üìÄ Otrzymano dane audio.");
            audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
            console.log("‚èπ Nagrywanie zako≈Ñczone. Tworzƒô plik audio...");
            let audioBlob = new Blob(audioChunks, { type: "audio/wav" });

            if (question === "intonation") {
                console.log("üìä Uruchamiam analyzePitch()...");
                await analyzePitch(audioBlob, question);
                console.log("‚úÖ analyzePitch() zako≈Ñczone!");
            }

            audioChunks = [];
        };

        document.getElementById(question + "_status").innerText = "Nagrywanie...";
    }).catch(error => {
        console.error("‚ùå B≈ÇƒÖd dostƒôpu do mikrofonu:", error);
    });
}

function stopRecording(question) {
    mediaRecorder.stop();
    document.getElementById(question + "_status").innerText = "Nagrywanie zako≈Ñczone.";
    mediaRecorder.onstop = async () => {
        let audioBlob = new Blob(audioChunks, { type: "audio/wav" });

        console.log(`üõë stopRecording() zosta≈Ça wywo≈Çana dla: ${question}`);
        console.log("üéô Otrzymano dane audio.");

        if (question === "intonation") {
            analyzeAudio(audioBlob, question, "{{ url_for('static', filename='sounds/note_c.wav') }}");
        } else if (question === "rhythm") {
            analyzeAudio(audioBlob, question, "{{ url_for('static', filename='sounds/rhythm_1.wav') }}");
        }

        audioChunks = [];
    };
}


async function analyzeAudio(audioBlob, question, referenceFile) {
    console.log(`üéµ Pobieram d≈∫wiƒôk wzorcowy dla: ${question}`);

    let referenceAudio = await fetch(referenceFile).then(res => res.arrayBuffer());
    let recordedAudio = await audioBlob.arrayBuffer();

    let refAudioData = await decodeAudio(referenceAudio);
    let userAudioData = await decodeAudio(recordedAudio);

    let similarity = compareSpectra(refAudioData, userAudioData);
    console.log(`üìä Wynik por√≥wnania (${question}):`, similarity);

    if (similarity > 0.8) {
        document.getElementById(question + "_result").innerHTML = "‚úÖ Poprawnie!";
        document.getElementById(question + "_result").setAttribute("data-score", "1"); // Dodajemy punkt
    } else {
        document.getElementById(question + "_result").innerHTML = "‚ùå Spr√≥buj ponownie.";
        document.getElementById(question + "_result").setAttribute("data-score", "0"); // Brak punktu
    }
}



async function decodeAudio(audioBuffer) {
    let audioContext = new AudioContext();
    return await audioContext.decodeAudioData(audioBuffer);
}

function compareSpectra(refAudio, userAudio) {
    console.log("üéß refAudio:", refAudio);
    console.log("üéß userAudio:", userAudio);

    if (!refAudio || !userAudio || refAudio.length === 0 || userAudio.length === 0) {
        console.warn("‚ùó Spektra sƒÖ puste lub nieprawid≈Çowe.");
        return 0;
    }

    const length = Math.min(refAudio.length, userAudio.length);
    let sum = 0;
    for (let i = 0; i < length; i++) {
        sum += Math.abs(refAudio[i] - userAudio[i]);
    }

    const similarity = 1 - (sum / length);
    return Math.max(0, similarity);
}

async function getSpectrum(audioData) {
    const offlineContext = new OfflineAudioContext(1, audioData.length, audioData.sampleRate);
    const source = offlineContext.createBufferSource();
    source.buffer = audioData;

    const analyser = offlineContext.createAnalyser();
    analyser.fftSize = 2048;
    const dataArray = new Float32Array(analyser.frequencyBinCount);

    source.connect(analyser);
    analyser.connect(offlineContext.destination);
    source.start();

    const renderedBuffer = await offlineContext.startRendering();

    const newAnalyser = offlineContext.createAnalyser();
    const newSource = offlineContext.createBufferSource();
    newSource.buffer = renderedBuffer;

    newSource.connect(newAnalyser);
    newAnalyser.connect(offlineContext.destination);
    newSource.start();

    newAnalyser.getFloatFrequencyData(dataArray);
    return dataArray;
}

function checkResults() {
    let score = 0;

    // Sprawdzenie odpowiedzi z nagra≈Ñ
    let rhythmScore = parseInt(document.getElementById("rhythm_result").getAttribute("data-score") || "0");
    let intonationScore = parseInt(document.getElementById("intonation_result").getAttribute("data-score") || "0");

    score += rhythmScore + intonationScore;

    // Poprawne odpowiedzi dla pyta≈Ñ wielokrotnego wyboru
    let correctAnswers = {
        "pitch1": 0,
        "melody": 1,
        "interval": 1,
        "instrument": 0
    };

    Object.keys(correctAnswers).forEach(question => {
        let options = document.getElementsByName(question);
        options.forEach((option, index) => {
            if (index === correctAnswers[question]) {
                option.parentElement.style.color = "green"; // Poprawna odpowied≈∫ - zielona
            } else if (option.checked) {
                option.parentElement.style.color = "red"; // B≈Çƒôdnie zaznaczona odpowied≈∫ - czerwona
            }
            if (option.checked && index === correctAnswers[question]) {
                score++;
            }
        });
    });

    alert("Tw√≥j wynik: " + score + " punkt√≥w!");
}

  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background-color: #f4f4f4;
    }
    h1, h2 {
      color: #333;
    }
    section {
      background-color: #fff;
      padding: 1rem;
      margin-bottom: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    audio {
      display: block;
      margin: 1rem 0;
    }
    label {
      display: block;
      margin-top: 0.5rem;
    }
    button {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <h1>Test Zdolno≈õci Muzycznych</h1>

  <section>
    <h2>1. Rozpoznawanie wysoko≈õci d≈∫wiƒôku</h2>
    <p>Ods≈Çuchaj dwa d≈∫wiƒôki:</p>
    <audio controls src="{{ url_for('static', filename='sounds/high_low_1.wav') }}"></audio>
    <label><input type="radio" name="pitch1"> Wy≈ºszy</label>
    <label><input type="radio" name="pitch1"> Ni≈ºszy</label>
    <label><input type="radio" name="pitch1"> Taki sam</label>
  </section>

  <section>
    <h2>2. Pamiƒôƒá muzyczna</h2>
    <p>Zapamiƒôtaj melodiƒô:</p>
    <audio controls src="{{ url_for('static', filename='sounds/melody_base.wav') }}"></audio>
    <p>Wybierz, kt√≥ra z poni≈ºszych by≈Ça identyczna:</p>
    <audio controls src="../static/sounds/melody_a.wav"></audio>
    <label><input type="radio" name="melody"> A</label>
    <audio controls src="../static/sounds/melody_b.wav"></audio>
    <label><input type="radio" name="melody"> B</label>
    <audio controls src="../static/sounds/melody_c.wav"></audio>
    <label><input type="radio" name="melody"> C</label>
  </section>

  <section>
    <h2>3. Rytm</h2>
    <p>Ods≈Çuchaj rytm i powt√≥rz go klaszczƒÖc:</p>
    <audio controls src="{{ url_for('static', filename='sounds/rhythm_1.wav') }}"></audio>
    <button onclick="startRecording('rhythm')">Nagrywaj</button>
    <button onclick="stopRecording('rhythm')">Zatrzymaj</button>
    <p id="rhythm_status"></p>
    <p id="rhythm_result"></p>
  </section>

  <section>
    <h2>4. Intonacja</h2>
    <p>Za≈õpiewaj d≈∫wiƒôk po jego us≈Çyszeniu:</p>
    <audio controls src="{{ url_for('static', filename='sounds/note_c.wav') }}"></audio>
    <button onclick="startRecording('intonation')">Nagrywaj</button>
    <button onclick="stopRecording('intonation')">Zatrzymaj</button>
    <p id="intonation_status"></p>
    <p id="intonation_result"></p>
  </section>
  <script></script>
  <section>
    <h2>5. Rozpoznawanie interwa≈Ç√≥w</h2>
    <p>JakƒÖ odleg≈Ço≈õƒá s≈Çychaƒá miƒôdzy dwoma d≈∫wiƒôkami?</p>
    <audio controls src="{{ url_for('static', filename='sounds/interval_c_to_e.wav') }}"></audio>
    <label><input type="radio" name="interval"> Sekunda</label>
    <label><input type="radio" name="interval"> Tercja</label>
    <label><input type="radio" name="interval"> Kwarta</label>
  </section>

  <section>
    <h2>6. Rozpoznawanie instrument√≥w</h2>
    <p>Jaki instrument s≈Çyszysz?</p>
    <audio controls src="{{ url_for('static', filename='sounds/instrument_violin.wav') }}"></audio>
    <label><input type="radio" name="instrument"> Skrzypce</label>
    <label><input type="radio" name="instrument"> Gitara</label>
    <label><input type="radio" name="instrument"> TrƒÖbka</label>
  </section>

  <button onclick="checkResults()">Sprawd≈∫ wynik</button>
</body>
</html>